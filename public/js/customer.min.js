var customers_data = [];
var selected_customer = 0;
var client_ids = [];
var client_data = [];

$(document).ready(function () {
    $(".customer:checked").each(function () {
        client_ids.push(parseInt($(this).val()));
    });
    $("#customers").val(JSON.stringify(client_ids));

    if (typeof contract == "undefined") {
        contracts = [];
    }
});

function searchCustomer() {
    var formData = new FormData();
    var url = $("#url-customer").val();
    var name = $("#customer-name").val();
    var phone = $("#customer-phone").val();
    var address = $("#customer-address").val();

    if (name == "" && phone == "" && address == "") {
        alert("Debes introducir al menos 1 dato de busqueda.");
        return;
    }

    formData.append("customer_name", name);
    formData.append("customer_phone", phone);
    formData.append("customer_address", address);

    getCustomers(formData, url);
}

function getCustomers(formData, url) {
    var html = "";
    var csrfToken = $('meta[name="csrf-token"]').attr("content");

    $.ajax({
        url: url,
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        success: function (response) {
            var customers = response["customers"];
            var sedes = response["sedes"];
            var client_customers = response["client_customers"];
            var i = 0;
            var arrFathers = [];
            customers_data = [];
            if (sedes.length > 0) {
                sedes.forEach(function (item) {
                    customers_data.push({
                        index: i,
                        id: item.id,
                        type: "Sede",
                        name: customers[
                            customers.findIndex(
                                (customer) => customer.id == item.general_sedes
                            )
                        ].name,
                        sede: item.name,
                        phone: item.phone == null ? "N/A" : item.phone,
                        address: item.address == null ? "N/A" : item.address,
                        status: selected_customer == item.id,
                    });
                    arrFathers.push(item.general_sedes);
                    i++;
                });
            }

            if (customers.length > 0) {
                customers.forEach(function (item) {
                    if (!arrFathers.includes(item.id)) {
                        customers_data.push({
                            index: i,
                            id: item.id,
                            type: "Cliente",
                            name: item.name,
                            phone: item.phone == null ? "N/A" : item.phone,
                            address:
                                item.address == null ? "N/A" : item.address,
                            status: selected_customer == item.id,
                        });
                    }
                    i++;
                });
            }
            if (new_client_account == true) {
                html += `<div class="accordion" id="accordionClient">`;
                client_customers.forEach((item) => {
                    html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${
                                item.id
                            }" aria-expanded="false">
                                ${item.name}
                            </button>
                        </h2>
                        <div id="collapse${
                            item.id
                        }" class="accordion-collapse collapse" data-bs-parent="#accordionClient">
                            <div class="accordion-body">
                                ${item.sedes
                                    .map(
                                        (sede) => `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${
                                        sede.id
                                    }" id="sede${
                                            sede.id
                                        }" onchange="setClientId(this.value, '${
                                            sede.name
                                        }')" ${
                                            client_ids.includes(sede.id)
                                                ? "checked"
                                                : ""
                                        }>
                                    <label class="form-check-label" for="sede${
                                        sede.id
                                    }">
                                        ${sede.name}
                                    </label>
                                </div>`
                                    )
                                    .join("")}
                            </div>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else {
                if (customers_data.length > 0) {
                    var customer_id = $("#customer-id").val();
                    const customer = customers_data.find(
                        (item) => item.id == customer_id
                    );
                    selected_customer = customer_id > 0 ? customer_id : 0;

                    customers_data.forEach(function (item) {
                        html += `
                        <a id="customer${
                            item.id
                        }" class="list-group-item list-group-item-action link-offset-3 ${
                            item.status || selected_customer == item.id
                                ? "active"
                                : ""
                        }" onclick="setCustomer(${item.id})">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1 fw-bold">${
                                    item.sede != undefined
                                        ? item.sede
                                        : item.name
                                }</h5>
                            </div>
                            <p class="mb-1">[${item.id}][${item.phone}] ${
                            item.address
                        }</p>
                        </a>
                    `;
                    });

                    if (customer) {
                        createCustomer(customer);

                        if (contracts.length > 0) {
                            selectContract(selected_customer);
                        }
                    }
                } else {
                    alert("Sin coincidencias");
                }
            }

            $("#customer-list").html(html);
            $("#customerModal").modal("show");
        },
        error: function (xhr, status, error) {
            console.error("Error:", error);
        },
    });
}

function setCustomer(customer_id) {
    console.log(contracts)
    const customer = customers_data.find((item) => item.id == customer_id);
    if (customer) {
        if (selected_customer == customer_id) {
            $("#customer" + customer_id).removeClass("active");
            selected_customer = 0;
            customer.status = false;
        } else {
            if (selected_customer > 0) {
                alert("Solo puedes seleccionar un cliente.");
            } else {
                $("#customer" + customer_id).addClass("active");
                selected_customer = customer_id;
                customer.status = true;
                createCustomer(customer);
            }
        }

        if (contracts.length > 0) {
            selectContract(selected_customer);
        }

        $("#customer-id").val(selected_customer);
    }
}

function selectContract(customer_id) {
    $("#contract").empty().append(new Option("Sin contrato", "0"));

    const selected_contracts = contracts.filter(
        (contract) => contract.customer_id == customer_id
    );
    selected_contracts.map((contract) => {
        $("#contract").append(
            new Option(
                `Contrato ${contract.id} (${contract.startdate} - ${contract.enddate})`,
                `${contract.id}`
            )
        );
    });
}

function createCustomer(customer) {
    $("#customer-select").html(
        `<div class="alert alert-success" role="alert">
            <div class="d-flex justify-content-between">
                <h4 class="alert-heading">Cliente seleccionado</h4>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="deleteCustomer()"></button>
            </div>
            <ul>
                <li class="text-break fw-bold">Cliente: <span class="fw-normal">${
                    customer.sede ? customer.sede : customer.name
                }</span></li>
                <li class="text-break fw-bold">Teléfono: <span class="fw-normal">${
                    customer.phone
                }</span></li>
                <li class="text-break fw-bold">Dirección: <span class="fw-normal">${
                    customer.address
                }</span></li>
            </ul>
        </div>`
    );
}

function createClient() {
    $("#customer-select").html(
        `<div class="alert alert-success" role="alert">
            <div class="d-flex justify-content-between">
                <h4 class="alert-heading">Sedes seleccionadas</h4>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="deleteCustomer()"></button>
            </div>
            <ul>
                ${client_data
                    .filter((client) => client_ids.includes(client.id)) // Filtra clientes que estén en client_ids
                    .map(
                        (client) => `
                    <li class="text-break fw-bold">Sede: <span class="fw-normal">${client.name}</span></li>`
                    )
                    .join("")}
            </ul>
        </div>`
    );
}

function deleteCustomer() {
    selected_customer = 0;
    client_ids = [];
    $("#customer-id").val("");
    $("#customers").val("");
    $("#contract").empty().append(new Option("Sin contrato", "0"));
}

function setClientId(id, name) {
    id = parseInt(id);
    if (!client_ids.includes(id)) {
        client_ids.push(id);
        client_data.push({
            id: id,
            name: name,
        });
    } else {
        client_ids = client_ids.filter((clientId) => clientId != id);
        client_data = client_data.filter((client) => client.id != id);
    }
    $("#customers").val(JSON.stringify(client_ids));

    createClient();
    if (client_ids <= 0) {
        deleteCustomer();
        $(".alert").alert("close");
    }
}
