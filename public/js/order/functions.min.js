const dayMap = {
    D: 0, // Domingo
    L: 1, // Lunes
    M: 2, // Martes
    Mi: 3, // Miércoles
    J: 4, // Jueves
    V: 5, // Viernes
    S: 6, // Sábado
};
const day_letters = ["L", "M", "Mi", "J", "V", "S", "D"];

var selected_services = [];
var aux = "";
var cost = 0;

// Genera la fecha de finalizacion del contrato
function set_endDate() {
    var startDateValue = $("#startdate").val();

    if (startDateValue) {
        var startDate = new Date(startDateValue);

        var endDate = new Date(startDate);
        endDate.setFullYear(endDate.getFullYear() + 1);
        endDate.setDate(endDate.getDate() - 1);

        var endDateFormatted = endDate.toISOString().split("T")[0];

        $("#enddate").val(endDateFormatted);
    }
}

function createService(service, i) {
    var html = `
            <tr>
                <th class="text-center" scope="row">${i + 1}</th>
                <td class="text-center">${service.name}</td>
                <td class="text-center">${service.type}</td>   
                <td class="text-center">${service.line}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteService(${i})"><i class="bi bi-trash-fill"></i> Eliminar</button>
                </td>
            </tr>
        `;
    cost += service.cost;
    return html;
}

function createServicesList() {
    console.log(selected_services)
    showServices();
}

function showServices() {
    var html = "";
    cost = 0;
    selected_services.forEach((service, i) => {
        html += createService(service, i);
    });
    $('#cost').val(cost);
    $('#price').val(cost * 1.5);
    $("#selected-services").html(html);
}

function deleteService(index) {
    if (index < 0 || index >= selected_services.length) {
        console.error("Índice no válido");
        return;
    }

    var service = selected_services[index];

    let selectedIndex = selected_services.findIndex(
        (item) => item.id == service.id,
    );
    if (selectedIndex != -1) {
        selected_services.splice(selectedIndex, 1);
        $("#service" + service.id).removeClass("active");
    }

    selected_services.splice(index, 1);
    selected_services.forEach((item, idx) => (item.index = idx));

    showServices();
}

function generateOrder() {
    const startTime = $("#start-time").val();
    const programmedDate = $("#programmed-date").val();
    const technicians = $('#technicians').val() != "" ? JSON.parse($('#technicians').val()) : [];
    const customer = $('#customer-id').val();

    if (startTime == "" && programmedDate == "") {
        alert("Incluye la hora de inicio y/o la fecha programada");
        return;
    }

    if (customer == "") {
        alert("Selecciona el cliente");
        return;
    }

    if (selected_services.length <= 0) {
        alert("Añade y/o configura los servicios");
        return;
    }

    if(technicians.length <= 0) {
        alert("Selecciona a los técnicos");
        return;
    }

    $("#services").val(JSON.stringify(selected_services.map(item => item.id)));
    $('#order-form').submit();
}

