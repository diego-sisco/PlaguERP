var services_data = [];
var selected_services = [];
var service_costs = [];

function searchService() {
    var item = $("#services-list");
    var html = "";
    var modal = $("#serviceModal");
    if ($("#search-service-input").val().length > 0) {
        getService(function (services) {
            services_data = services;
            if (services.length > 0) {
                services.forEach((service) => {
                    html += `
                        <a id="service${
                            service.id
                        }" class="list-group-item list-group-item-action ${
                            service.status ? "active" : ""
                        }" onclick="setService(${service.id})">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1 fw-bold">[${service.id}] ${
                                    service.name
                                }</h5>
                            </div>
                            <ul>
                                <li class="text-break fw-bold">Tipo: <span class="fw-normal">${
                                    service.type
                                }</span></li>
                                <li class="text-break fw-bold">Línea: <span class="fw-normal">${
                                    service.bussLine
                                }</span></li>
                                <li class="text-break fw-bold">Plagas: <span class="fw-normal">${shortenString(
                                    service.pests.length > 0
                                        ? service.pests.join(", ")
                                        : "S/P",
                                )}</span></li>
                                <li class="text-break fw-bold">Métodos: <span class="fw-normal">${shortenString(
                                    service.appMethods.length > 0
                                        ? service.appMethods.join(", ")
                                        : "S/M",
                                )}</span></li>
                            </ul>
                        </a>
                    `;
                });
                item.html(html);
                modal.modal("show");
            } else {
                alert("Sin coincidencias");
            }
        });
    } else {
        alert("Debes introducir al menos 1 dato de busqueda.");
    }
}

function shortenString(str) {
    var size = 50;
    if (str.length > size) {
        return str.substring(0, size) + "...";
    }
    return str;
}

function getService(callback) {
    const formData = new FormData();
    const csrfToken = $('meta[name="csrf-token"]').attr("content");
    var url = "";

    url = $("#url-service-input").val();
    formData.append("search_service_input", $("#search-service-input").val());

    $.ajax({
        url: url,
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        headers: {
            "X-CSRF-TOKEN": csrfToken,
        },
        success: function (response) {
            const services = response.services;
            const service_types = response.service_types;
            const business_lines = response.business_lines;
            const pests = response.pests;
            const app_methods = response.app_methods;

            if (services.length > 0) {
                callback(
                    services.map((service, i) => {
                        return {
                            id: service.id,
                            name: service.name,
                            type: service_types[i],
                            bussLine: business_lines[i],
                            pests: pests[i],
                            appMethods: app_methods[i],
                            status: selected_services.some(
                                (item) => item.id == service.id,
                            ),
                            cost: service.cost,
                        };
                    }),
                );
            } else {
                callback([]);
            }
        },
        error: function (error) {
            console.error(error);
            callback([]);
        },
    });
}

function setService(service_id) {
    if (selected_services.some((service) => service.id == service_id)) {
        let index = selected_services.findIndex(
            (service) => service.id == service_id,
        );
        if (index != -1) {
            selected_services.splice(index, 1);
        }

        $("#service" + service_id).removeClass("active");
    } else {
        service = services_data.find((item) => item.id == service_id);
        if (service) {
            selected_services.push({
                id: service_id,
                name: service.name,
                type: service.type,
                line: service.bussLine,
                cost: service.cost,
            });
            $("#service" + service_id).addClass("active");
        }
    }

    //createServicesList();
}
