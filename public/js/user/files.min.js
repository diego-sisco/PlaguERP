var files_arr = new FormData();

$(document).ready(function () {
    const dropArea = $("#drop-area");
    const fileInput = $("#file-input");
    const output = $("#output");

    dropArea.on("dragover", function (event) {
        event.preventDefault();
        dropArea.addClass("dragover");
    });

    dropArea.on("dragleave", function () {
        dropArea.removeClass("dragover");
    });

    dropArea.on("drop", function (event) {
        event.preventDefault();
        dropArea.removeClass("dragover");
        const files = event.originalEvent.dataTransfer.files;
        handleFiles(files);
    });

    fileInput.on("change", function (event) {
        const files = event.target.files;
        handleFiles(files);
    });

    function handleFiles(files) {
        let html = "";
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (!checkFileSize(file)) {
                files_arr.append("files[]", file);
                const parts = file.type.split("/"); // Divide la cadena en partes usando el "/" como separador
                const valueAfterDash = parts[1];
                if (valueAfterDash.toString().toLowerCase() == "pdf") {
                    html = `<i class="bi bi-filetype-pdf me-1 text-danger"></i>`;
                } else {
                    html = `<i class="bi bi-image me-1 text-primary"></i>`;
                }
                html += `${file.name} <br/>`;
                output.append(html);
            } else {
                alert("El archivo no puede ser mayor a 3 MB");
                $("#form-drop-area")[0].reset();
                $("#output").html("");
                $("#file-input").val("");
            }
        }
    }
});

function upload_files(_id) {
    var files_url = $("#files_url").val();
    var _type = $("#type").val();
    files_arr.append("id", _id);
    files_arr.append("type", _type);
    const csrfToken = $('meta[name="csrf-token"]').attr("content")
    
    for (var pair of files_arr.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
    }
    
    if (_type == null || _type.trim() === "") {
        alert("No se ha seleccionado el tipo de archivo");
        return;
    } else {
        $.ajax({
            url: files_url,
            type: "POST",
            data: files_arr,
            contentType: false,
            processData: false,
            dataType: 'json',
            headers: {
                "X-CSRF-TOKEN": csrfToken,
            },
            success: function (response) {
                if (response.error != null) {
                    alert(response.error);
                }
                if (response.success != null) {
                    location.reload();
                   alert(response.success);
                }
            },
            error: function (error) {
                console.log("Error:", error);
            },
        });

        files_arr = new FormData();
        $("#output").html("");
        $("#file-input").val("");
    }
}

function checkFileSize(input) {
    const maxSizeInBytes = 3 * 1024 * 1024; // 3 MB
    if (input.size > maxSizeInBytes) {
        return true;
    }
    return false;
}